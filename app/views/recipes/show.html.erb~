<% provide(:title, "#{@recipe.title} Recipe") %>
<% provide(:canonical, recipe_url(@recipe)) %>
<% provide(:desc, "") %>
<div class="span8">
  <div itemscope itemtype="http://schema.org/Recipe" class="row">
    <div class="span5">
      <h1 itemprop="name" class="recipe-show-h1"><%= @recipe.title %></h1>
    </div>
    <div class="span3">
      <span class="float-right pretty-pic-top"><%= link_to image_tag("#{avatar_url(@recipe.user)}?s=35"), user_path(@recipe.user) %></span>
      <span class="float-right">
        <% if can? :update, @recipe %>
          <%= link_to "<i class=\"icon-star username-star-top\"></i>#{@recipe.user.username}".html_safe, user_path(@recipe.user_id), class: "pretty-username username-top float-right", itemprop: "author" %>
        <% else %>
          <%= link_to @recipe.user.username, user_path(@recipe.user_id), class: "pretty-username username-top float-right", itemprop: "author" %>
        <% end %>
        <time itemprop="datePublished" datetime="<%= @recipe.created_at %>"><%= content_tag :p, pretty_date(@recipe.created_at), class: "pretty-date float-right clear-right" %></time>
      </span>
    </div>
  </div>

  <div itemscope itemtype="http://schema.org/Recipe" class="row">
    <div class="span3">
      <span class="drop-shadow lifted">
        <% if @recipe.picture.present? %>
          <%= image_tag(@recipe.picture_url(:thumb), itemprop: "image" ) %> 
        <% else %>
          <%= image_tag 'default.jpg', itemprop: "image" %>
        <% end %>
      </span>
    </div>
    <div class="span5">
      <div class="position-relative">
        <table class="recipe-meta">
          <tr>
            <td class="show-label">Prep And Cook Time:</td>
            <td><meta itemprop="totalTime" content="PT<%= @recipe.cooking_time %>H"><%= @recipe.cooking_time %> minutes</td>
          </tr>
          <tr>
            <td class="show-label">Servings:</td>
            <td><span itemprop="recipeYield"><%= @recipe.servings %> <%= @recipe.servings == 1 ? "Person" : "Persons" %></span></td>
          </tr>
          <tr>
            <td class="show-label">Pots/Pans Required:</td>
            <td><%= @recipe.pots %></td>
          </tr>
          <% if @recipe.calories.present? %>
            <tr>
              <td class="show-label">Calories Per Person:</td>
              <td><%= content_tag :span, @recipe.calories, itemprop: "calories" %></td>
            </tr>
          <% end %>
          </table>
          <% if can? :update, @recipe %>
            <%= link_to 'Edit Recipe', edit_recipe_path(@recipe), class: "edit-recipe-btn float-right btn btn-mini btn-warning bolded" %>
          <% end %>
          <% if can? :destroy, @recipe %>
            <%= link_to 'Delete Recipe', @recipe, method: :delete, data: { confirm: 'Are you sure?' }, class: "float-right clear-right btn btn-mini btn-danger bolded" %>
          <% end %>
          <table class="recipe-meta">
          <% if @recipe.weight.present? %>
            <tr>
              <td class="show-label">Ingredient's Weight:</td>
              <td><%= @recipe.weight %> grams <span class="gray-me">(<%= convert_to_pounds(@recipe.weight) %> pounds)</span></td>
            </tr>
          <% end %>
          <tr>
            <td class="show-label">Equipment Needed:</td>
            <td><%= link_to @recipe.equipment, cooking_gear_path %></td>
          </tr>
          <tr>
            <td class="show-label">Average Rating:</td>
            <td class="average-stars"><span itemprop="aggregateRating" itemscope itemtype="http://schema.org/AggregateRating"><meta itemprop="ratingValue" content="<%= @recipe.average_stars %>"><%= content_tag(:span, "", class: "rated", data_rating: @recipe.average_stars ) %> <span class="gray-me">(<span itemprop="reviewCount"><%= @recipe.reviews.count %></span> <%= @recipe.reviews.count == 1 ? "Review" : "Reviews" %>)</span></td>
          </tr>
        </table>
        <div class="position-fixed">
          <div class="row">
            <div class="span5">
              <div class="show-social-buttons">
                <div class="pin-button">
                  <a href="http://pinterest.com/pin/create/button/?url=<%= recipe_url(@recipe) %>&media=<%= @recipe.picture_url(:thumb) %>&description=<%= @recipe.title %> Recipe" class="pin-it-button" count-layout="horizontal"><img border="0" src="//assets.pinterest.com/images/PinExt.png" title="Pin It" /></a>
                </div>
                <div class="fb-like" data-send="false" data-layout="button_count" data-width="90" data-show-faces="true"></div>
                <div class="g-plusone" data-size="medium" data-annotation="inline" data-width="120" data-href="<%= recipe_url(@recipe) %>"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div itemscope itemtype="http://schema.org/Recipe" class="row">
    <div class="span8">
      <h3 class="h-margin">Recipe Introduction</h3>
      <span itemprop="description"><%= simple_format @recipe.introduction %></span>
    </div>
  </div>

  <div itemscope itemtype="http://schema.org/Recipe" class="row">
    <div class="span6">
      <h3 class="h-margin">Ingredients</h3>
      <ul>
        <% @recipe.ingredients.each do |ing| %>
          <li><span itemprop="ingredients"><%= ing.name %></span></li>
        <% end %>
      </ul>
    </div>
    <div class="span2">
      <h3 class="h-margin">Categories</h3>
      <ul class="cat-list drop-shadow lifted">
        <% @recipe.categories.each do |cat| %>
          <li><span itemprop="recipeCategory"><%= link_to cat.name, category_index_path(cat.name.parameterize), class: 'fonted' %></span></li>
        <% end %>
      </ul>    
    </div>
  </div>

  <div itemscope itemtype="http://schema.org/Recipe" class="row">
    <div class="span8">
      <h3 class="h-margin">Recipe Preperation</h3>
      <span itemprop="recipeInstructions"><%= simple_format @recipe.preperation %></span>
    </div>
  </div>
  <div class="row">
    <div class="span4">
      <h3 class="h-margin">Reviews</h3>
    </div>
    <div class="span4">
      <% if @existing_review == false %>
        <a href="#reviewModal" role="button" class="float-right add-review-btn btn btn-warning bolded" data-toggle="modal">Add Review</a>
        <div id="reviewModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
            <h3 id="myModalLabel">Add Review</h3>
          </div>
          <div class="modal-body">
            <% if can? :create, Review %>
              <%= form_for(@review) do |f| %>
                <div class="review-rating" id="rating"></div>
                <div class="field">
                  <%= f.hidden_field :recipe_id, :value => @recipe.id %>
                  <%= f.text_area :content %>
                </div>
              </div>
              <div class="modal-footer">
                <div class="actions">
                  <%= f.submit %>
                  <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="fonted">Oops, you cant write a review until we know who you are. <%= link_to "Sign in", new_user_session_path %> if you already have an account, or else <%= link_to "sign up", new_user_registration_path %> for one.</p>
            </div>
            <div class="modal-footer">
              <div class="actions">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <% if @all_reviews.present? %>
    <% @all_reviews.each do |review| %>
      <div class="row">
        <div itemprop="review" itemscope itemtype="http://schema.org/Review" class="span8">
          <div class="review-meta">
            <div class="row">
              <div class="span4">
                <span class="float-left pretty-pic-reviews"><%= link_to image_tag("#{avatar_url(review.user)}?s=35"), user_path(review.user) %></span>
                <span class="float-left">
                  <% if can? :update, review %>
                    <%= link_to "<i class=\"icon-star username-star\"></i>#{review.user.username}".html_safe, user_path(review.user_id), class: "pretty-username", itemprop: "author" %>
                  <% else %>
                    <%= link_to review.user.username, user_path(review.user_id), class: "pretty-username", itemprop: "author" %>
                  <% end %>
                  <time itemprop="datePublished" datetime="<%= review.created_at %>"><%= content_tag :p, pretty_date(review.created_at), class: "pretty-date" %></time>
                </span>
              </div>
              <div class="span4">
                <% if can? :destroy, review %>
                  <%= link_to 'Delete Review', review, method: :delete, data: { confirm: 'Are you sure?' }, class: "edit-review-btn float-right btn btn-mini btn-danger bolded" %>
                <% end %>
                <% if can? :update, review %>
                  <%= link_to 'Edit Review', edit_review_path(review), class: "edit-review-btn float-right btn btn-mini btn-warning bolded" %>
                <% end %>
                <span itemprop="reviewRating" itemscope itemtype="http://schema.org/Rating">
                  <meta itemprop="ratingValue" content="<%= review.stars %>">
                </span>
                <%= content_tag(:span, "", class: "rated show-review-stars", data_rating: review.stars ) %>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="span8">
              <div class="review-content">
                <span itemprop="reviewBody"><%= review.content %></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="row">
      <div class="span8">
        <p class="no-reviews">Unfortunately no one has written a review for the <%= @recipe.title %> recipe just yet, but you could be the first...</p>
      </div>
    </div>
  <% end %>
</div>

<div class="span4">
  <%= render 'shared/sidebar' %>
</div>


<script type="text/javascript">
  $('#rating').raty({
    scoreName : 'review[stars]',
    scoreId : 'review_stars'
});
</script>


module ApplicationHelper
  
  def update_sidebar_links
    require 'open-uri'
    require 'nokogiri'
    
    Link.where("link_type = ?", 'sidebar').delete_all

    url = "http://www.avantlink.com/api.php?affiliate_id=31645&module=ProductSearch&output=xml&website_id=124521&search_term=Backpacker%27s+Pantry%7CMountain+House%7C+Mary+Janes+Farm&search_advanced_syntax=1&merchant_ids=10060%7C10248&search_results_fields=Merchant+Name%7CProduct+Name%7CRetail+Price%7CSale+Price%7CAbbreviated+Description%7CThumbnail+Image%7CBuy+URL&search_results_count=5&search_results_sort_order=Price+Discount+Percent%7Cdesc&search_results_options=precise%7Cinterleave"

    doc = Nokogiri::XML.parse(open(url))
    my_hash = doc.search('//Table1').map{ |e| Hash.from_xml(e.to_xml)['Table1'] }
    my_hash.each do |hash|
      new_hash = {}
      hash.each do |key, value|
        new_hash[key.downcase] = value
      end
      new_hash['link_type'] = 'sidebar'
      Link.new(new_hash).save
    end
  end
  
  def full_title(page_title) #Returns the full title on a per-page basis.
    base_title = "Camping Recipes"
    if page_title.empty?
      base_title
    elsif page_title == "home"
      "#{base_title} | Recipes to take Camping and Backpacking"
    else
      "#{page_title} | #{base_title}"
    end
  end
  
  def meta_desc(desc) #Returns the full title on a per-page basis.
    if desc.empty?
      "Camping recipes and backpacking recipes to keep you well fed while working hard in the outdoors"
    else
      desc
    end
  end
  
  def pretty_date(date)
    date = date.to_date
    new_date = date.strftime("%b #{date.day.ordinalize}, %Y")
  end
  
  def flash_class(level) #change rails alerts in to bootstrap alerts (associated partial and application.html code)
   case level
    when :notice then "alert alert-info"
    when :success then "alert alert-success"
    when :error then "alert alert-error"
    when :alert then "alert alert-error"
    end
  end
  
  def avatar_url(user)
    gravatar_id = Digest::MD5::hexdigest(user.email).downcase
    "http://gravatar.com/avatar/#{gravatar_id}.png"
  end
end
